<!-- app/templates/base_multiple_items.html -->
{% extends "base.html" %}
{% import "bootstrap/utils.html" as utils %}
{% import "bootstrap/wtf.html" as wtf %}

{% block content2 %}
<div class="content-section">
  {{ utils.flashed_messages() }}
    <!-- begin message block -->
<div class="container flashed-messages">
  <div class="row">
    <div class="col-md-12" id="flash-list">
      <!--<div class="alert alert-info" role="alert">Wrong date format, must be of form d-m-y</div>-->
    </div>
  </div>
</div>
<!-- end message block -->

  <div class="center">
      <form method="post" action="{{ url_for(route) }}">
      <table class="table-condensed ">
          <tr>
{% if filter.since %}
              <th>Since</th>
{% endif %}
{% if filter.value %}
              <th>Value</th>
{% endif %}
{% if filter.location %}
              <th>Location</th>
{% endif %}
{% if filter.category %}
              <th>Category </th>
{% endif %}
{% if filter.status %}
              <th>Status</th>
{% endif %}
{% if filter.supplier %}
              <th>Supplier</th>
{% endif %}
{% if filter.device %}
              <th>Device</th>
{% endif %}
          </tr>
          <tr>
{% if filter.since %}
              <td><input id="date_after" class="filter" name="date_after" type="text" size="12" value="{{ filter.date_after }}"></td>
{% endif %}
{% if filter.value %}
              <td><input id="value_from" class="filter" name="value_from" type="text" size="12" value="{{ filter.value_from }}"></td>
{% endif %}
{% if filter.location %}
              <td><input id="room" class="filter" name="room" type="text" size="12" value="{{ filter.room }}"></td>
{% endif %}
{% if filter.category %}
              <td rowspan="2"  >{{ wtf.form_field(filter.category.category) }}</td>
{% endif %}
{% if filter.status %}
              <td rowspan="2">{{ wtf.form_field(filter.status.status) }}</td>
{% endif %}
{% if filter.supplier %}
              <td rowspan="2">{{ wtf.form_field(filter.supplier.supplier) }}</td>
{% endif %}
{% if filter.device %}
              <td rowspan="2">{{ wtf.form_field(filter.device.device) }}</td>
{% endif %}
          </tr>
          <tr>
{% if filter.since %}
              <td><input id="date_before" class="filter" name="date_before" type="text" size="12" value="{{ filter.date_before }}"></td>
{% endif %}
{% if filter.value %}
              <td><input id="value_till" class="filter" name="value_till" type="text" size="12" value="{{ filter.value_till }}"></td>
{% endif %}
          </tr>
      </table>
      <br>
      <div class="btn-group" role="group" aria-label="...">
            <!--<input class="btn btn-default" id="submit" name="button" type="submit" value="Filter">-->
          <a class="btn btn-default" id="filter"">Filter</a>
            <a class="btn btn-default" id="clear">Clear</a>
      </div>
      </form>
      <hr />
      <form method="post" action="{{ url_for(subject + '.add') }}" novalidate>
      <div class="btn-group" role="group" aria-label="...">
           <input class="btn btn-default" id="add" name="add" type="submit" value="Add {{subject}}">
      </div>
      <hr />
      <table cellspacing="0" class="table table-striped table-bordered " id="datatable" width="100%">
          <thead><tr>
              {% for h in header_list %}
                <th>{{h.name}}</th>
              {% endfor %}
          </thead>
      </table>
      </form>
  </div>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
//Before removing an entry, a confirm-box is shown.  This function works together with on-draw.dt event here below
function confirm_before_delete() {
    id = $(this).attr('u_id');
    bootbox.confirm("Are you sure want to delete this " + '{{subject}}' + "?", function(result) {
        if (result) {
            window.location.href = Flask.url_for('{{subject}}' + ".delete", {'id' : id})
        }
    });
}

$(document).ready(function() {
    // When the length-changer or pager of the table is used, not all delete-buttons have the confirm-before-delete event
    // attached.  The event draw.dt makes sure that, after the table is redrawn (length change or repaged) that all rows
    // are bound to the confirm-before-delete event.

    $('.confirmBeforeDelete').click(confirm_before_delete); //when page is loaded, default attach confirm_before_delete function

    $('#datatable').on('draw.dt', function() {
        $('.confirmBeforeDelete').unbind();
        $('.confirmBeforeDelete').click(confirm_before_delete);
    });

    //The clear button of the filter is pushed
    $('#clear').click(function() {
        $('.filter').val('');
        $('#category').val('');
        $('#status').val('');
        $('#device').val('');
        $('#supplier').val('');
        table.ajax.reload();
    });

    //The filter button of the filter is pushed
    $('#filter').click(function() {
        table.ajax.reload();
    });

     var table = $('#datatable').DataTable({
        serverSide: true,
        dom : 'liptp',
        ajax: {
            url: '/{{subject}}/data',
            type: 'POST',
            data : function (d) {
                return $.extend( {}, d, {
                    "date_before" : $('#date_before').val(),
                    "date_after" : $('#date_after').val(),
                    "value_from" : $('#value_from').val(),
                    "value_till" : $('#value_till').val(),
                    "category" : $('#category').val(),
                    "status" : $('#status').val(),
                    "device" : $('#device').val(),
                    "supplier" : $('#supplier').val(),
                    "room" : $('#room').val()
                });
            }
        },
        searching : false,
        pagingType: "full_numbers",
        lengthMenu: [5, 25, 50, 100],
        "columns": [
        {% for h in header_list %}
            {data: "{{h.data}}", name: "{{h.name}}"},
        {% endfor %}
        ]
      });

        table.on( 'draw', function () {
            var j = table.ajax.json();
            if(typeof j.redirect == 'string') {
                window.location.href = Flask.url_for('asset.assets');
            }

            $("#flash-list").html('');
            if(j.flash && j.flash.length) {
                var flash_string="";
                for(let s of j.flash) {
                    flash_string += "<div class=\"alert alert-info\" role=\"alert\">" + s +"</div>";
                }
                    $("#flash-list").html(flash_string);
            }
        } );

});
</script>
{% endblock %}
