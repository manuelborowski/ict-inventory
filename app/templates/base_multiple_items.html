<!-- app/templates/base_multiple_items.html -->
{% extends "base.html" %}
{% import "bootstrap/utils.html" as utils %}
{% import "bootstrap/wtf.html" as wtf %}

{% block content2 %}
<div class="content-section">
  {{ utils.flashed_messages() }}
    <!-- begin message block -->
<div class="container flashed-messages">
  <div class="row">
    <div class="col-md-12" id="flash-list">
    </div>
  </div>
</div>
<!-- end message block -->

  <div class="center">
      <form method="post" action="{{ url_for(route) }}">
      <table class="table-condensed ">
          <tr>
{% if filter.since %}
              <th>Since</th>
{% endif %}
{% if filter.value %}
              <th>Value</th>
{% endif %}
{% if filter.location %}
              <th>Location</th>
{% endif %}
{% if filter.category %}
              <th>Category </th>
{% endif %}
{% if filter.status %}
              <th>Status</th>
{% endif %}
{% if filter.supplier %}
              <th>Supplier</th>
{% endif %}
{% if filter.device %}
              <th>Device</th>
{% endif %}
          </tr>
          <tr>
{% if filter.since %}
              <td><input id="date_after" class="filter" name="date_after" type="text" size="12"></td>
{% endif %}
{% if filter.value %}
              <td><input id="value_from" class="filter" name="value_from" type="text" size="12"></td>
{% endif %}
{% if filter.location %}
              <td><input id="room" class="filter" name="room" type="text" size="12"></td>
{% endif %}
{% if filter.category %}
              <td rowspan="2"  >{{ wtf.form_field(filter.category.category) }}</td>
{% endif %}
{% if filter.status %}
              <td rowspan="2">{{ wtf.form_field(filter.status.status) }}</td>
{% endif %}
{% if filter.supplier %}
              <td rowspan="2">{{ wtf.form_field(filter.supplier.supplier) }}</td>
{% endif %}
{% if filter.device %}
              <td rowspan="2">{{ wtf.form_field(filter.device.device) }}</td>
{% endif %}
          </tr>
          <tr>
{% if filter.since %}
              <td><input id="date_before" class="filter" name="date_before" type="text" size="12"></td>
{% endif %}
{% if filter.value %}
              <td><input id="value_till" class="filter" name="value_till" type="text" size="12"></td>
{% endif %}
          </tr>
      </table>
      <br>
      <div class="btn-group" role="group" aria-label="...">
          <a class="btn btn-default" id="filter">Filter</a>
          <a class="btn btn-default" id="clear">Clear</a>
      </div>
      </form>
      <hr />
      <form method="post" action="{{ url_for(subject + '.add') }}" novalidate>
      <div class="btn-group" role="group" aria-label="...">
           <input class="btn btn-default" id="add" name="add" type="submit" value="Add {{subject}}">
      </div>
      <hr />
      <table cellspacing="0" class="table table-striped table-bordered " id="datatable" width="100%">
          <thead><tr>
              {% for h in header_list %}
                <th>{{h.name}}</th>
              {% endfor %}
          </thead>
      </table>
      </form>
  </div>
</div>


<div id="menu">
  <a id="edit_menu_item" href="">Edit</a>
  <a id="copy_menu_item" href="">Copy from</a>
  <a id="add_menu_item" href="">Add</a>
  <a id="view_menu_item" href="">View</a>
  <a id="delete_menu_item">Delete</a>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    //The clear button of the filter is pushed
    $('#clear').click(function() {
        $('.filter').val('');
        $('#category').val('');
        $('#status').val('');
        $('#device').val('');
        $('#supplier').val('');
        //emulate click on trigger button
        $('#filter').trigger('click');
    });

    var filter_settings
    //Get content from localstorage and store in fields
    try {
        filter_settings = JSON.parse(localStorage.getItem("Filter"));
        $('#date_before').val(filter_settings['date_before']);
        $('#date_after').val(filter_settings['date_after']);
        $('#value_from').val(filter_settings['value_from']);
        $('#value_till').val(filter_settings['value_till']);
        $('#category').val(filter_settings['category']);
        $('#status').val(filter_settings['status']);
        $('#device').val(filter_settings['device']);
        $('#supplier').val(filter_settings['supplier']);
        $('#room').val(filter_settings['room']);
    } catch (err) {
        //$('#category').val("")edge
    }

    //The filter button of the filter is pushed
    $('#filter').click(function() {
        //Store filter in localstorage
        filter_settings = {"date_before" : $('#date_before').val(),
                   "date_after" : $('#date_after').val(),
                   "value_from" : $('#value_from').val(),
                   "value_till" : $('#value_till').val(),
                   "category" : $('#category').val(),
                   "status" : $('#status').val(),
                   "device" : $('#device').val(),
                   "supplier" : $('#supplier').val(),
                   "room" : $('#room').val()}
        //alert(JSON.stringify(filter_settings));
        localStorage.setItem("Filter", JSON.stringify(filter_settings));
        table.ajax.reload();
    });

    //Configure datatable.
    var table = $('#datatable').DataTable({
       serverSide: true,
       stateSave: true,
       dom : 'lfiptp',
       ajax: {
           url: '/{{subject}}/data',
           type: 'POST',
           data : function (d) {
               return $.extend( {}, d, filter_settings);
           }
       },
       pagingType: "full_numbers",
       lengthMenu: [5, 25, 50, 100],
       "columns": [
       {% for h in header_list %}
           {data: "{{h.data}}", name: "{{h.name}}"},
       {% endfor %}
       ]
    });

     //flash messages, if required
     table.on( 'draw', function () {
        var j = table.ajax.json();
        $("#flash-list").html('');
        if(j.flash && j.flash.length) {
            var flash_string="";
            for(let s of j.flash) {
                flash_string += "<div class=\"alert alert-info\" role=\"alert\">" + s +"</div>";
            }
                $("#flash-list").html(flash_string);
        }
     });

    //Before removing an entry, a confirm-box is shown.
    function confirm_before_delete(id) {
        //id = $(this).attr('u_id');
        bootbox.confirm("Are you sure want to delete this " + '{{subject}}' + "?", function(result) {
            if (result) {
                window.location.href = Flask.url_for('{{subject}}' + ".delete", {'id' : id})
            }
        });
    }

    //right click on an item in the table.  A menu pops up to execute an action on the selected row/item
    var i = document.getElementById("menu").style;
    document.getElementById("datatable").addEventListener('contextmenu', function(e) {
        var posX = e.clientX;
        var posY = e.clientY;
        menu(posX, posY);
        e.preventDefault();
        var item_id = $(e.target).closest('tr').prop('id');
        document.getElementById("edit_menu_item").href = Flask.url_for('{{subject}}' + ".edit", {'id' : item_id});
        document.getElementById("add_menu_item").href = Flask.url_for('{{subject}}' + ".add");
        document.getElementById("copy_menu_item").href = Flask.url_for('{{subject}}' + ".add", {'id' : item_id});
        document.getElementById("view_menu_item").href = Flask.url_for('{{subject}}' + ".view", {'id' : item_id});
        document.getElementById("delete_menu_item").onclick= function(){ confirm_before_delete(item_id)};
    }, false);
    document.getElementById("datatable").addEventListener('click', function(e) {
        i.opacity = "0";
        setTimeout(function() {i.visibility = "hidden";}, 1);
    }, false);

    function menu(x, y) {
      i.top = y + "px";
      i.left = x + "px";
      i.visibility = "visible";
      i.opacity = "1";
    }

});
</script>
{% endblock %}
