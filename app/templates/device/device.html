<!-- app/templates/auth/user.html -->
<!-- this form is used for adding a user as well for editing a user, hence the if-clause -->

{% import "bootstrap/wtf.html" as wtf %}
{% extends "base_single_item.html" %}

{% block content3 %}
    {{ wtf.form_field(form.category) }}
    {{ wtf.form_field(form.brand) }}
    {{ wtf.form_field(form.type) }}
    {{ wtf.form_field(form.power) }}
    {{ wtf.form_field(form.ce) }}

    <div class="input-group">
        {{ wtf.form_field(form.risk_analysis) }}
        <div class="input-group-btn">
            <input class="btn btn-default" id="risk_analysis_download" type="button" value="Download">
            {% if role == "edit" %}
                <input class="btn btn-default" id="risk_analysis_upload" type="button" value="Upload">
            {% endif %}
        </div>
    </div>

    <input id='risk_analysis_fileid' type='file' name='ra_filename' style="visibility : hidden" hidden/>

    <script>
        init_up_download('risk_analysis');


        function init_up_download(file_type) {
            file_el = file_type + '_fileid';
            upload_el = file_type + '_upload';
            download_el = file_type + '_download';
            fd = document.getElementById(file_el);

            {% if role == "edit" %}
                //The actual filedialog element is hidden because it does not blend in with the bootstrap css.
                //Pushing the bootstrap-upload button generates a click-event on the filedialog element
                document.getElementById(upload_el).addEventListener('click', function(){fd.click();});
            {% endif %}
            document.getElementById(download_el).addEventListener('click', download);

            //Called when the filedialog closes
            fd.addEventListener('change',   function(e) {
                //console.log(fd.files[0].name);
                var _select = document.getElementById(file_type);
                 for(var i=0; i < _select.options.length; i++) {
                    console.log(_select.options[i].value);
                    if (_select.options[i].value == fd.files[0].name) {
                        toastr.error('File "' + fd.files[0].name + '" already exists, select another one');
                        fd.value="";
                        return;
                    }
                }
                var option = document.createElement("option");
                option.text = fd.files[0].name;
                _select.add(option, 0);
                _select.selectedIndex = "0";
             });

            //To download the file, jump to the download url with the filename as parameter
            function download() {
                var _file = document.getElementById(file_type).value;
                window.location.href = Flask.url_for("device.download", {'type' : this.id,'file' : _file});
            }
        }
    </script>
{% endblock %}